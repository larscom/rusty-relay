name: workflow

on:
  push:
    tags:
      - '*.*.*'
    branches:
      - '**'
  merge_group:
  pull_request:
    branches:
      - main

jobs:
  crates-build:
      name: Build and Test (${{ matrix.os }} - ${{ matrix.target }})
      runs-on: ${{ matrix.os }}
      strategy:
        fail-fast: false
        matrix:
          include:
            # Linux
            - os: ubuntu-latest
              target: x86_64-unknown-linux-gnu
              arch: x86_64
              platform: linux
            - os: ubuntu-latest
              target: aarch64-unknown-linux-gnu
              arch: arm64
              platform: linux
            # macOS
            - os: macos-latest
              target: x86_64-apple-darwin
              arch: x86_64
              platform: macos
            - os: macos-latest
              target: aarch64-apple-darwin
              arch: arm64
              platform: macos
            # Windows
            - os: windows-latest
              target: x86_64-pc-windows-msvc
              arch: x86_64
              platform: windows
            - os: windows-latest
              target: aarch64-pc-windows-msvc
              arch: arm64
              platform: windows

      steps:
        - name: Checkout repository
          uses: actions/checkout@v5

        - name: Set up Rust
          uses: dtolnay/rust-toolchain@stable
          with:
            targets: ${{ matrix.target }}

        - name: Cache cargo
          uses: actions/cache@v4
          with:
            path: |
              ~/.cargo/registry
              ~/.cargo/git
              target/${{ matrix.target }}
            key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
            restore-keys: ${{ runner.os }}-${{ matrix.target }}-cargo-
       
        - name: Clippy
          run: cargo clippy --workspace --all-targets --verbose -- -D warnings

        - name: Build
          run: cargo build --workspace --release --target ${{ matrix.target }}

        - name: Test
          run: cargo test --workspace --target ${{ matrix.target }}

        - name: Package binaries
          shell: bash
          run: |
            mkdir -p dist
            for crate in rusty-relay-client rusty-relay-server; do
              bin="target/${{ matrix.target }}/release/$crate"
              if [[ "${{ matrix.platform }}" == "windows" ]]; then
                bin="${bin}.exe"
                zip_name="${crate}-${{ matrix.platform }}-${{ matrix.arch }}.zip"
                7z a "dist/$zip_name" "$bin" > /dev/null
              else
                zip_name="${crate}-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz"
                tar -czf "dist/$zip_name" -C "$(dirname "$bin")" "$(basename "$bin")"
              fi
            done
        - name: Upload packaged binaries
          uses: actions/upload-artifact@v4
          with:
            name: ${{ matrix.platform }}-${{ matrix.arch }}
            path: dist/*

  docker-build:
    if: github.event_name != 'pull_request'
    needs: [crates-build]
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read    
    steps:
      - uses: actions/checkout@v5
      - run: |
          REF_NAME="${{ github.ref_name }}"          
          REF_NAME_LOWER=$(echo "$REF_NAME" | tr '[:upper:]' '[:lower:]')          
          REF_NAME_CLEAN=$(echo "$REF_NAME_LOWER" | tr -cd '[:alnum:]._-')          
          REF_NAME_CLEAN=$(echo "$REF_NAME_CLEAN" | sed 's/^[^a-z0-9]*//;s/[^a-z0-9]*$//')          
          if [[ ! "$REF_NAME_CLEAN" =~ ^[a-z0-9] ]]; then
            REF_NAME_CLEAN="0$REF_NAME_CLEAN"
          fi          
          echo "CLEANED_REF_NAME=$REF_NAME_CLEAN" >> $GITHUB_ENV      
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
 
      - uses: docker/build-push-action@v6
        if: startsWith(github.ref, 'refs/tags/')
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/rusty-relay:latest,ghcr.io/${{ github.repository_owner }}/rusty-relay:${{ github.ref_name }}
      - uses: docker/build-push-action@v6
        if: startsWith(github.ref, 'refs/heads/')
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/rusty-relay:${{ env.CLEANED_REF_NAME }}
